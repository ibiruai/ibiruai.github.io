<!DOCTYPE html>
<!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å –ø–æ–º–æ—â—å—é —è–∑—ã–∫–æ–≤–æ–π –º–æ–¥–µ–ª–∏ -->
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ó–∞–≥—Ä—É–∑–∫–∞...</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <header>
    <h1 id="page-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
    <select id="file-selector"></select>
    <button class="toggle-theme" onclick="toggleTheme()">üåì</button>
  </header>
  <main id="content">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</main>

  <script src="js/js-yaml.min.js"></script>
  <script>
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const savedTheme = localStorage.getItem('theme');
    const defaultTheme = savedTheme || (prefersDark ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', defaultTheme);

    function toggleTheme() {
      const html = document.documentElement;
      const current = html.getAttribute('data-theme');
      const newTheme = current === 'light' ? 'dark' : 'light';
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    }

    async function fetchIndex() {
      const res = await fetch('./config.yaml', { cache: 'reload' });
      const text = await res.text();
      return jsyaml.load(text);
    }

    async function loadYAMLFile(filename) {
        const res = await fetch(filename, { cache: 'reload' });
        const text = await res.text();
        return jsyaml.load(text, { schema: jsyaml.FAILSAFE_SCHEMA });
    }

    function getDeclension(number, words) {
      number = Math.abs(number) % 100;
      const n1 = number % 10;
      if (number > 10 && number < 20) return words[2];
      if (n1 > 1 && n1 < 5) return words[1];
      if (n1 === 1) return words[0];
      return words[2];
    }

    function calculateDuration(fromDateStr) {
      const now = new Date();
      const fromDate = new Date(fromDateStr);
      if (isNaN(fromDate)) return '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞';

      let diff = now - fromDate;

      const msInSecond = 1000;
      const msInMinute = msInSecond * 60;
      const msInHour = msInMinute * 60;
      const msInDay = msInHour * 24;

      const years = Math.floor(diff / (msInDay * 365));
      diff -= years * msInDay * 365;

      const months = Math.floor(diff / (msInDay * 30));
      diff -= months * msInDay * 30;

      const days = Math.floor(diff / msInDay);
      diff -= days * msInDay;

      const hours = Math.floor(diff / msInHour);
      diff -= hours * msInHour;

      const minutes = Math.floor(diff / msInMinute);
      diff -= minutes * msInMinute;

      const seconds = Math.floor(diff / msInSecond);

      const hasDay = /\d{4}-\d{2}-\d{2}/.test(fromDateStr);
      const hasTime = /(\d{2}:\d{2}(:\d{2})?)/.test(fromDateStr);

      let parts = [];

      if (!hasDay) {
        if (years > 0) parts.push(`${years} ${getDeclension(years, ['–≥–æ–¥', '–≥–æ–¥–∞', '–ª–µ—Ç'])}`);
        if (months > 0) parts.push(`${months} ${getDeclension(months, ['–º–µ—Å—è—Ü', '–º–µ—Å—è—Ü–∞', '–º–µ—Å—è—Ü–µ–≤'])}`);
      } else if (!hasTime) {
        if (years > 0) parts.push(`${years} ${getDeclension(years, ['–≥–æ–¥', '–≥–æ–¥–∞', '–ª–µ—Ç'])}`);
        if (months > 0) parts.push(`${months} ${getDeclension(months, ['–º–µ—Å—è—Ü', '–º–µ—Å—è—Ü–∞', '–º–µ—Å—è—Ü–µ–≤'])}`);
        if (days > 0) parts.push(`${days} ${getDeclension(days, ['–¥–µ–Ω—å', '–¥–Ω—è', '–¥–Ω–µ–π'])}`);
      } else {
        if (years > 0) parts.push(`${years} ${getDeclension(years, ['–≥–æ–¥', '–≥–æ–¥–∞', '–ª–µ—Ç'])}`);
        if (months > 0) parts.push(`${months} ${getDeclension(months, ['–º–µ—Å—è—Ü', '–º–µ—Å—è—Ü–∞', '–º–µ—Å—è—Ü–µ–≤'])}`);
        if (days > 0) parts.push(`${days} ${getDeclension(days, ['–¥–µ–Ω—å', '–¥–Ω—è', '–¥–Ω–µ–π'])}`);
        if (hours > 0) parts.push(`${hours} ${getDeclension(hours, ['—á–∞—Å', '—á–∞—Å–∞', '—á–∞—Å–æ–≤'])}`);
        if (minutes > 0) parts.push(`${minutes} ${getDeclension(minutes, ['–º–∏–Ω—É—Ç–∞', '–º–∏–Ω—É—Ç—ã', '–º–∏–Ω—É—Ç'])}`);
        if (seconds > 0) parts.push(`${seconds} ${getDeclension(seconds, ['—Å–µ–∫—É–Ω–¥–∞', '—Å–µ–∫—É–Ω–¥—ã', '—Å–µ–∫—É–Ω–¥'])}`);
      }

      return parts.length > 0 ? parts.join(' ') : '0 —Å–µ–∫—É–Ω–¥';
    }


    function renderItem(item) {
      const div = document.createElement('div');
      div.className = 'item';

      if (item['–Ω–∞–∑–≤–∞–Ω–∏–µ']) {
        const title = document.createElement('div');
        title.className = 'item-title';
        title.textContent = item['–Ω–∞–∑–≤–∞–Ω–∏–µ'];
        div.appendChild(title);
      }

      for (const key in item) {
        if (key === '–Ω–∞–∑–≤–∞–Ω–∏–µ') continue;

        const field = document.createElement('div');
        field.className = 'field';

        const label = document.createElement('strong');
        label.textContent = key.replace(/_/g, ' ') + ': ';
        field.appendChild(label);

        if (typeof item[key] === 'string' && item[key].startsWith('from(')) {
          const dateStr = item[key].slice(5, -1);
          const valueSpan = document.createElement('span');
          valueSpan.textContent = calculateDuration(dateStr);
          field.appendChild(valueSpan);

          setInterval(() => {
            valueSpan.textContent = calculateDuration(dateStr);
          }, 1000);
        } else {
          const valueSpan = document.createElement('span');
          valueSpan.textContent = item[key];
          field.appendChild(valueSpan);
        }

        div.appendChild(field);
      }

      return div;
    }

    function renderPage(data) {
      const main = document.getElementById('content');
      main.innerHTML = '';

      for (const key in data) {
        if (key === 'title') continue;
        const section = data[key];
        if (Array.isArray(section)) {
          section.forEach(item => {
            main.appendChild(renderItem(item));
          });
        }
      }
    }

    function toggleTheme() {
      const html = document.documentElement;
      const current = html.getAttribute('data-theme');
      html.setAttribute('data-theme', current === 'light' ? 'dark' : 'light');
    }

    async function init() {
      try {
        const index = await fetchIndex();
        const select = document.getElementById('file-selector');
        const fileMap = {};

        index.files.forEach(entry => {
          const file = typeof entry === 'string' ? entry : entry.file;
          const title = typeof entry === 'string' ? file.replace(/\.yaml$/, '') : entry.title || file;
          fileMap[file] = title;

          const option = document.createElement('option');
          option.value = file;
          option.textContent = title;
          select.appendChild(option);
        });

        async function loadSelectedFile() {
          const filename = select.value;
          const data = await loadYAMLFile(filename);

          const title = fileMap[filename] || '–°–ø–∏—Å–æ–∫';
          document.title = title;
          document.getElementById('page-title').textContent = title;

          renderPage(data);
        }

        select.addEventListener('change', loadSelectedFile);

        if (index.files.length > 0) {
          const firstFile = typeof index.files[0] === 'string' ? index.files[0] : index.files[0].file;
          select.value = firstFile;
          await loadSelectedFile();
        }

      } catch (err) {
        document.getElementById('content').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ config.yaml –∏–ª–∏ –æ–¥–Ω–æ–≥–æ –∏–∑ —Ñ–∞–π–ª–æ–≤: ' + err;
      }
    }

    init();
  </script>
</body>
</html>
